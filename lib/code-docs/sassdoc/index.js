'use strict';

const sassDocExtras = require('sassdoc-extras');
const MixinNode = require('./nodes/mixin');
const FunctionNode = require('./nodes/function');
const VariableNode = require('./nodes/variable');

class SassDoc {

    constructor(componentName, brand, doclets) {
        this.brand = brand;
        this.doclets = doclets;
        this.groupNameAliases = {
            'undefined': componentName,
        };
    }

    getNodesByKind() {
        return this.getNodes().filter(item => item.kind).reduce((nodeByKind, item) => {
            nodeByKind[item.kind] = nodeByKind[item.kind] || [];
            nodeByKind[item.kind].push(item);
            return nodeByKind;
        }, {});
    }

    /**
     * @returns {string[]} Kinds of SassDoc doclets which are supported.
     */
    static supportedDoclets() {
        return ['mixin', 'function', 'variable'];
    }

    /**
     * Format a doclet by removing superfluous properties and adding any custom properties.
     * @param {Object} doclet - A raw json doclet generated by SassDoc.
     * @returns {Object} Formatted node.
     */
    static formatDoclet(doclet) {
        switch (doclet.context.type) {
            case 'mixin':
                return new MixinNode(doclet);
                break;
            case 'function':
                return new FunctionNode(doclet);
                break;
            case 'variable':
                return new VariableNode(doclet);
                break;
            case 'placeholder':
            default:
                throw new Error(`SassDoc type "${doclet.context.type}" is not supported by the registry.`);
                break;
        };
    }

    getNodes() {
        if (! this._formattedDoclets) {
            // Apply default values for groups and display.
            const context = {
                display: {
                    access: ['public'],
                },
                groups: this.groupNameAliases,
                data: this.doclets
            };

            // Remove any non-public doclets (configured above by the 'display' property).
            // http://sassdoc.com/extra-tools/#display-toggle-display
            sassDocExtras.display(context);
            // Customise @group names (configured above by the 'groups' above).
            // http://sassdoc.com/extra-tools/#groups-aliases-groupname
            sassDocExtras.groupName(context);
            // Remove doclet kinds the registry does not recognise or support. E.g. placeholders.
            // These cause Origami users issues so are hidden. If used at all, placeholders should be internal to Origami only.
            // https://github.com/Financial-Times/ft-origami/issues/205
            // https://github.com/Financial-Times/ft-origami/issues/293
            context.data = context.data.filter(doclet => doclet.context && SassDoc.supportedDoclets().includes(doclet.context.type));
            // Filter out doclets that are not for the current brand.
            context.data = context.data.filter((doclet) => {
                const hasSupportedBrands = doclet.brand && doclet.brand.supported && doclet.brand.supported.length > 0;
                return doclet.brand === undefined || hasSupportedBrands === false || hasSupportedBrands && doclet.brand.supported.includes(this.brand);
            });
            // Filter out doclets which are implicity private.
            context.data = context.data.filter((doclet) => {
                if (doclet.context && doclet.context.name) {
                    return doclet.context.name.indexOf('_') !== 0;
                }
                return true;
            });
            // Format data for registry use.
            this._formattedDoclets = context.data.map(doclet => SassDoc.formatDoclet(doclet));
        }
        return this._formattedDoclets;
    }
}

module.exports = SassDoc;
